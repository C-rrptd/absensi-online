<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi & Jadwal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Style untuk modal */
        #schedule-modal-bg { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 max-w-4xl">

        <!-- ===== HALAMAN LOGIN ===== -->
        <div id="login-page" class="page active">
            <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto mt-10">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Selamat Datang</h1>
                    <p class="text-gray-500">Pilih peran Anda untuk masuk</p>
                </div>
                
                <!-- Tab Pilihan Role -->
                <div class="mb-4 flex border-b">
                    <button id="tab-siswa" class="flex-1 py-2 text-center font-semibold text-blue-600 border-b-2 border-blue-600">Siswa</button>
                    <button id="tab-admin" class="flex-1 py-2 text-center font-semibold text-gray-500">Admin</button>
                </div>

                <!-- Form Login Siswa -->
                <form id="student-login-form">
                    <div class="mb-4">
                        <label for="nisn" class="block text-sm font-medium text-gray-700 mb-1">NISN</label>
                        <input type="text" id="nisn" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="student_name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="student_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <p id="student-login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700">Masuk sebagai Siswa</button>
                </form>

                <!-- Form Login Admin -->
                <form id="admin-login-form" class="hidden">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <p id="admin-login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-gray-800 text-white font-semibold py-3 rounded-lg hover:bg-gray-900">Masuk sebagai Admin</button>
                </form>
            </div>
        </div>

        <!-- ===== HALAMAN DASBOR SISWA ===== -->
        <div id="student-dashboard-page" class="page">
             <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow">
                <div>
                    <p class="text-gray-500">Selamat Datang,</p>
                    <h2 id="student-dashboard-name" class="text-2xl font-bold text-gray-800"></h2>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="showPage('student-attendance-page')">
                    <h3 class="text-xl font-bold text-gray-800">Absensi Hari Ini</h3>
                    <p class="text-gray-500 mt-2">Catat kehadiran dan waktu pulang Anda di sini.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="viewSchedule('student')">
                    <h3 class="text-xl font-bold text-gray-800">Lihat Jadwal Pelajaran</h3>
                    <p class="text-gray-500 mt-2">Lihat jadwal pelajaran mingguan Anda.</p>
                </div>
            </div>
        </div>

        <!-- ===== HALAMAN ABSENSI SISWA ===== -->
        <div id="student-attendance-page" class="page">
            <button onclick="showPage('student-dashboard-page')" class="mb-4 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg">&larr; Kembali ke Dasbor</button>
            <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-md mx-auto">
                 <div class="bg-gray-50 p-4 rounded-lg mb-6 border">
                    <p id="current-time" class="text-2xl font-semibold text-gray-700">00:00:00</p>
                    <p id="current-date" class="text-gray-500"></p>
                </div>
                <div id="morning-status-message" class="mb-2 p-4 rounded-lg text-sm font-medium hidden"></div>
                <div id="afternoon-status-message" class="mb-4 p-4 rounded-lg text-sm font-medium hidden"></div>
                <div id="attendance-buttons" class="space-y-3">
                     <p id="instruction-text" class="text-gray-600 mb-3">Memuat data...</p>
                    <button id="morning-button" onclick="recordMorningAttendance()" class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 hidden">Catat Kehadiran Pagi</button>
                    <button id="afternoon-button" onclick="recordAfternoonCheckout()" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 hidden">Catat Waktu Pulang</button>
                    <button id="izin-button" onclick="recordSpecialStatus('Izin')" class="w-full bg-yellow-500 text-white font-semibold py-3 rounded-lg hover:bg-yellow-600 hidden">Izin</button>
                    <button id="sakit-button" onclick="recordSpecialStatus('Sakit')" class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 hidden">Sakit</button>
                </div>
            </div>
        </div>

        <!-- ===== HALAMAN PANEL ADMIN ===== -->
        <div id="admin-page" class="page">
            <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow">
                <h2 class="text-2xl font-bold text-gray-800">Panel Admin - Jadwal Pelajaran</h2>
                <button onclick="logout()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
            </div>
             <div class="bg-white p-6 rounded-xl shadow">
                <div class="flex justify-end mb-4">
                    <button onclick="openScheduleModal()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Tambah Jadwal</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left">Hari</th>
                                <th class="py-3 px-4 text-left">Jam</th>
                                <th class="py-3 px-4 text-left">Mata Pelajaran</th>
                                <th class="py-3 px-4 text-left">Guru</th>
                                <th class="py-3 px-4 text-left">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-table-body">
                            <!-- Data jadwal akan dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ===== MODAL & VIEWER JADWAL ===== -->
        <div id="schedule-modal-bg" class="fixed inset-0 hidden items-center justify-center p-4" onclick="closeScheduleModal(event)">
             <!-- Modal Form Jadwal (untuk Admin) -->
            <div id="schedule-modal-admin" class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-lg hidden" onclick="event.stopPropagation()">
                <h3 id="modal-title" class="text-2xl font-bold mb-6">Tambah Jadwal Baru</h3>
                <form id="schedule-form">
                    <input type="hidden" id="schedule-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="day" class="block text-sm font-medium">Hari</label>
                            <select id="day" class="w-full mt-1 p-2 border rounded-lg">
                                <option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option><option>Sabtu</option>
                            </select>
                        </div>
                         <div>
                            <label for="subject" class="block text-sm font-medium">Mata Pelajaran</label>
                            <input type="text" id="subject" class="w-full mt-1 p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="start_time" class="block text-sm font-medium">Jam Mulai</label>
                            <input type="time" id="start_time" class="w-full mt-1 p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="end_time" class="block text-sm font-medium">Jam Selesai</label>
                            <input type="time" id="end_time" class="w-full mt-1 p-2 border rounded-lg" required>
                        </div>
                         <div class="md:col-span-2">
                            <label for="teacher_name" class="block text-sm font-medium">Nama Guru</label>
                            <input type="text" id="teacher_name" class="w-full mt-1 p-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                         <button type="button" onclick="closeScheduleModal()" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg">Batal</button>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg">Simpan</button>
                    </div>
                </form>
            </div>
            <!-- Viewer Jadwal (untuk Siswa) -->
            <div id="schedule-viewer-student" class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-3xl hidden" onclick="event.stopPropagation()">
                 <h3 class="text-2xl font-bold mb-6 text-center">Jadwal Pelajaran</h3>
                 <div id="student-schedule-content" class="overflow-y-auto max-h-[70vh]"></div>
                 <div class="mt-6 text-center">
                    <button type="button" onclick="closeScheduleModal()" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg">Tutup</button>
                 </div>
            </div>
        </div>

    </div>

    <script>
    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = 'https://kzbrgjlrclrefjsfeiqa.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6YnJnamxyY2xyZWZqc2ZlaXFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NzY5NTYsImV4cCI6MjA3NDI1Mjk1Nn0.NbnerBeOF1TfHd8g72i_xKR1vc5LrezSV2uN5LvsMzQ';
    
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- VARIABEL GLOBAL & STATE ---
    let currentUser = null;
    let currentRole = null; // 'student' atau 'admin'
    let clockInterval = null;
    let todaysRecord = null;
    let scheduleChannel = null; // Variabel untuk menyimpan channel realtime
    
    // --- ELEMEN DOM ---
    const pages = document.querySelectorAll('.page');
    const studentLoginForm = document.getElementById('student-login-form');
    const adminLoginForm = document.getElementById('admin-login-form');
    const tabSiswa = document.getElementById('tab-siswa');
    const tabAdmin = document.getElementById('tab-admin');
    const studentDashboardName = document.getElementById('student-dashboard-name');
    const scheduleForm = document.getElementById('schedule-form');
    const modalBg = document.getElementById('schedule-modal-bg');
    const adminModal = document.getElementById('schedule-modal-admin');
    const studentViewer = document.getElementById('schedule-viewer-student');

    // --- FUNGSI UTAMA ---

    function showPage(pageId) {
        pages.forEach(page => {
            page.classList.toggle('active', page.id === pageId);
        });

        // Logika spesifik saat halaman ditampilkan
        if (pageId === 'admin-page') {
            loadAdminSchedule();
            subscribeToScheduleChanges(); // Aktifkan realtime saat masuk halaman admin
        }
        if (pageId === 'student-attendance-page') {
            setupAttendancePage();
        }
    }

    function logout() {
        currentUser = null;
        currentRole = null;
        if(clockInterval) clearInterval(clockInterval);
        
        // Hentikan langganan realtime saat logout
        if (scheduleChannel) {
            db.removeChannel(scheduleChannel);
            scheduleChannel = null;
        }

        studentLoginForm.reset();
        adminLoginForm.reset();
        showPage('login-page');
    }

    // --- LOGIKA LOGIN ---
    
    function setupLoginTabs() {
        tabSiswa.addEventListener('click', () => {
            tabSiswa.classList.add('text-blue-600', 'border-blue-600');
            tabSiswa.classList.remove('text-gray-500');
            tabAdmin.classList.add('text-gray-500');
            tabAdmin.classList.remove('text-blue-600', 'border-blue-600');
            studentLoginForm.classList.remove('hidden');
            adminLoginForm.classList.add('hidden');
        });

        tabAdmin.addEventListener('click', () => {
            tabAdmin.classList.add('text-blue-600', 'border-blue-600');
            tabAdmin.classList.remove('text-gray-500');
            tabSiswa.classList.add('text-gray-500');
            tabSiswa.classList.remove('text-blue-600', 'border-blue-600');
            adminLoginForm.classList.remove('hidden');
            studentLoginForm.classList.add('hidden');
        });
    }

    async function handleStudentLogin(e) {
        e.preventDefault();
        const nisn = document.getElementById('nisn').value.trim();
        const name = document.getElementById('student_name').value.trim();
        const errorEl = document.getElementById('student-login-error');
        errorEl.classList.add('hidden');

        try {
            const { data, error } = await db.from('students').select('*').eq('nisn', nisn).ilike('name', name).single();
            if (error) throw error;
            if (data) {
                currentUser = data;
                currentRole = 'student';
                studentDashboardName.textContent = currentUser.name;
                showPage('student-dashboard-page');
            }
        } catch (error) {
            errorEl.textContent = "NISN atau Nama tidak cocok.";
            errorEl.classList.remove('hidden');
            console.error("Student login error:", error);
        }
    }

    async function handleAdminLogin(e) {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorEl = document.getElementById('admin-login-error');
        errorEl.classList.add('hidden');

        try {
            const { data, error } = await db.from('admins').select('*').eq('username', username).eq('password', password).single();
            if (error) throw error;
            if (data) {
                currentUser = data;
                currentRole = 'admin';
                showPage('admin-page');
            }
        } catch (error) {
            errorEl.textContent = "Username atau Password salah.";
            errorEl.classList.remove('hidden');
            console.error("Admin login error:", error);
        }
    }

    // --- LOGIKA JADWAL (ADMIN & SISWA) ---

    // Fungsi baru untuk berlangganan perubahan pada tabel jadwal
    function subscribeToScheduleChanges() {
        if (scheduleChannel) return; // Jika sudah berlangganan, jangan buat lagi

        scheduleChannel = db.channel('public:schedule')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'schedule' }, payload => {
                console.log('Perubahan pada jadwal terdeteksi!', payload);
                // Muat ulang data jadwal untuk menampilkan perubahan secara realtime
                loadAdminSchedule();
            })
            .subscribe();
    }


    async function loadAdminSchedule() {
        const { data, error } = await db.from('schedule').select('*').order('day').order('start_time');
        if(error) {
            console.error("Error fetching schedule:", error);
            return;
        }
        
        const tableBody = document.getElementById('schedule-table-body');
        tableBody.innerHTML = '';
        data.forEach(item => {
            tableBody.innerHTML += `
                <tr class="border-b">
                    <td class="py-3 px-4">${item.day}</td>
                    <td class="py-3 px-4">${item.start_time.slice(0,5)} - ${item.end_time.slice(0,5)}</td>
                    <td class="py-3 px-4">${item.subject}</td>
                    <td class="py-3 px-4">${item.teacher_name || '-'}</td>
                    <td class="py-3 px-4">
                        <button onclick="editSchedule('${item.id}')" class="text-blue-500 hover:underline mr-2">Edit</button>
                        <button onclick="deleteSchedule('${item.id}')" class="text-red-500 hover:underline">Hapus</button>
                    </td>
                </tr>
            `;
        });
    }

    async function viewSchedule(role) {
        const { data, error } = await db.from('schedule').select('*').order('day').order('start_time');
        if(error) return console.error(error);
        
        const contentEl = document.getElementById('student-schedule-content');
        contentEl.innerHTML = '';
        
        const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        days.forEach(day => {
            const lessonsForDay = data.filter(d => d.day === day);
            if(lessonsForDay.length > 0) {
                contentEl.innerHTML += `<h4 class="text-lg font-bold mt-4 mb-2 border-b pb-1">${day}</h4>`;
                let dayScheduleHTML = '<ul class="space-y-2">';
                lessonsForDay.forEach(lesson => {
                    dayScheduleHTML += `<li class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-semibold">${lesson.subject}</p>
                        <p class="text-sm text-gray-600">${lesson.start_time.slice(0,5)} - ${lesson.end_time.slice(0,5)}</p>
                        <p class="text-sm text-gray-500">Guru: ${lesson.teacher_name || '-'}</p>
                    </li>`;
                });
                dayScheduleHTML += '</ul>';
                contentEl.innerHTML += dayScheduleHTML;
            }
        });
        
        adminModal.classList.add('hidden');
        studentViewer.classList.remove('hidden');
        modalBg.classList.add('flex');
        modalBg.classList.remove('hidden');
    }

    function openScheduleModal(id = null, data = {}) {
        scheduleForm.reset();
        document.getElementById('schedule-id').value = id || '';
        document.getElementById('modal-title').textContent = id ? 'Edit Jadwal' : 'Tambah Jadwal Baru';
        
        if (id) {
            document.getElementById('day').value = data.day;
            document.getElementById('start_time').value = data.start_time;
            document.getElementById('end_time').value = data.end_time;
            document.getElementById('subject').value = data.subject;
            document.getElementById('teacher_name').value = data.teacher_name;
        }

        studentViewer.classList.add('hidden');
        adminModal.classList.remove('hidden');
        modalBg.classList.add('flex');
        modalBg.classList.remove('hidden');
    }

    function closeScheduleModal(event = null) {
        if(event && event.target.id !== 'schedule-modal-bg') return;
        modalBg.classList.add('hidden');
        modalBg.classList.remove('flex');
    }

    async function handleScheduleSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('schedule-id').value;
        const scheduleData = {
            day: document.getElementById('day').value,
            start_time: document.getElementById('start_time').value,
            end_time: document.getElementById('end_time').value,
            subject: document.getElementById('subject').value,
            teacher_name: document.getElementById('teacher_name').value,
        };

        let query;
        if (id) {
            query = db.from('schedule').update(scheduleData).eq('id', id);
        } else {
            query = db.from('schedule').insert([scheduleData]);
        }

        const { error } = await query;
        if(error) {
            alert("Gagal menyimpan jadwal: " + error.message);
        } else {
            closeScheduleModal();
            // Tidak perlu memanggil loadAdminSchedule() di sini karena realtime akan menanganinya
        }
    }

    window.editSchedule = async function(id) {
        const { data, error } = await db.from('schedule').select('*').eq('id', id).single();
        if(error) return alert("Gagal mengambil data jadwal");
        openScheduleModal(id, data);
    }
    
    window.deleteSchedule = async function(id) {
        if(confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
            const { error } = await db.from('schedule').delete().eq('id', id);
            if(error) return alert("Gagal menghapus jadwal");
            // Tidak perlu memanggil loadAdminSchedule() di sini karena realtime akan menanganinya
        }
    }

    // --- LOGIKA ABSENSI (SISWA) ---

    function updateClock() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
        document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    async function setupAttendancePage() {
        if (!currentUser) return;
        updateClock();
        if (clockInterval) clearInterval(clockInterval);
        clockInterval = setInterval(updateClock, 1000);
        
        [...document.querySelectorAll('#morning-status-message, #afternoon-status-message, #morning-button, #afternoon-button, #izin-button, #sakit-button')].forEach(el => el.classList.add('hidden'));
        document.getElementById('instruction-text').textContent = "Memuat data...";

        const today = new Date().toISOString().split('T')[0];
        try {
            const { data, error } = await db.from('attendance').select('*').eq('student_id', currentUser.id).eq('date', today).single();
            if (error && error.code !== 'PGRST116') throw error;
            todaysRecord = data;
            updateUIAbsensi();
        } catch (error) {
            console.error("Error fetching attendance:", error);
            document.getElementById('instruction-text').textContent = "Gagal memuat data absensi.";
        }
    }

    function updateUIAbsensi() {
        // (Fungsi ini sama seperti versi sebelumnya, tidak perlu diubah signifikan)
        const instructionText = document.getElementById('instruction-text');
        const morningStatusEl = document.getElementById('morning-status-message');
        const afternoonStatusEl = document.getElementById('afternoon-status-message');
        [morningStatusEl, afternoonStatusEl].forEach(el => el.classList.add('hidden'));

        const now = new Date();
        const currentHour = now.getHours();

        if (todaysRecord?.morning_status) {
            showStatusMessage(morningStatusEl, `Pagi: Tercatat '${todaysRecord.morning_status}' jam ${todaysRecord.morning_time}.`, todaysRecord.morning_status);
        }
        if (todaysRecord?.afternoon_status) {
            showStatusMessage(afternoonStatusEl, `Sore: Tercatat '${todaysRecord.afternoon_status}' jam ${todaysRecord.afternoon_time}.`, todaysRecord.afternoon_status);
        }
        
        const buttons = {
            morning: document.getElementById('morning-button'),
            afternoon: document.getElementById('afternoon-button'),
            izin: document.getElementById('izin-button'),
            sakit: document.getElementById('sakit-button')
        };
        Object.values(buttons).forEach(btn => btn.classList.add('hidden'));

        if (!todaysRecord?.morning_status) {
            instructionText.textContent = "Silakan catat kehadiran Anda hari ini:";
            buttons.izin.classList.remove('hidden');
            buttons.sakit.classList.remove('hidden');
            if (currentHour < 9) {
                buttons.morning.classList.remove('hidden');
            } else {
                instructionText.textContent = "Waktu absensi pagi sudah berakhir.";
            }
        } else if (!todaysRecord?.afternoon_status) {
            instructionText.textContent = "Menunggu waktu pulang...";
            if (currentHour >= 10 && currentHour < 16) {
                instructionText.textContent = "Silakan catat waktu pulang Anda.";
                buttons.afternoon.classList.remove('hidden');
            } else if (currentHour >= 16) {
                instructionText.textContent = "Waktu untuk mencatat kepulangan sudah berakhir.";
            }
        } else {
            instructionText.textContent = "Absensi hari ini sudah lengkap. Terima kasih!";
        }
    }
    
    function showStatusMessage(element, message, status) {
        element.textContent = message;
        element.className = 'mb-2 p-4 rounded-lg text-sm font-medium text-left';
        const statusClasses = {
            'Hadir Tepat Waktu': 'bg-green-100 text-green-800', 'Terlambat': 'bg-orange-100 text-orange-800',
            'Pulang Tepat Waktu': 'bg-blue-100 text-blue-800', 'Izin': 'bg-yellow-100 text-yellow-800',
            'Sakit': 'bg-red-100 text-red-800', 'default': 'bg-gray-100 text-gray-800'
        };
        const classes = statusClasses[status] || statusClasses['default'];
        classes.split(' ').forEach(c => element.classList.add(c));
    }
    
    // Fungsi record... (recordMorningAttendance, dll) sama persis seperti versi sebelumnya
    window.recordMorningAttendance = async function() {
        const now = new Date();
        const time = now.toLocaleTimeString('id-ID', { hour12: false });
        const today = now.toISOString().split('T')[0];
        let status = (now.getHours() < 6 || (now.getHours() === 6 && now.getMinutes() < 30)) ? 'Hadir Tepat Waktu' : 'Terlambat';
        const { error } = await db.from('attendance').insert({ student_id: currentUser.id, date: today, morning_status: status, morning_time: time });
        if(error) return alert("Gagal menyimpan absensi: " + error.message);
        setupAttendancePage();
    }
    window.recordAfternoonCheckout = async function() {
        const now = new Date();
        const time = now.toLocaleTimeString('id-ID', { hour12: false });
        const { error } = await db.from('attendance').update({ afternoon_status: 'Pulang Tepat Waktu', afternoon_time: time }).eq('id', todaysRecord.id);
        if(error) return alert("Gagal menyimpan absensi: " + error.message);
        setupAttendancePage();
    }
    window.recordSpecialStatus = async function(status) {
        const now = new Date();
        const time = now.toLocaleTimeString('id-ID', { hour12: false });
        const today = now.toISOString().split('T')[0];
        const { error } = await db.from('attendance').insert({ student_id: currentUser.id, date: today, morning_status: status, morning_time: time, afternoon_status: "N/A", afternoon_time: "00:00:00" });
        if(error) return alert("Gagal menyimpan status: " + error.message);
        setupAttendancePage();
    }


    // --- INISIALISASI ---
    document.addEventListener('DOMContentLoaded', () => {
        setupLoginTabs();
        studentLoginForm.addEventListener('submit', handleStudentLogin);
        adminLoginForm.addEventListener('submit', handleAdminLogin);
        scheduleForm.addEventListener('submit', handleScheduleSubmit);
        showPage('login-page');
    });

    </script>
</body>
</html>

